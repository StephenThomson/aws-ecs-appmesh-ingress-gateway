 upstream application_in_task {
    server platform-status-frontend.public.appmesh:_APP_PORT ;

}

log_format json_log_format escape=json '{"body_bytes_sent": $body_bytes_sent, '
'"bytes_sent": $bytes_sent, '
'"connection": "$connection", '
'"gzip_ratio": "$gzip_ratio", '
'"hostname": "$hostname", '
'"http_host": "$host", '
'"http_referrer": "$http_referer", '
'"http_user_agent": "$http_user_agent", '
'"http_x_request_chain": "$http_x_request_chain", '
'"http_x_client_id": "$http_x_client_id", '
'"http_x_application_id": "$http_x_application_id", '
'"http_x_session_id": "$http_x_session_id", '
'"http_x_request_id": "$http_x_request_id", '
'"remote_addr": "$remote_addr", '
'"http_true_client_ip": "$http_true_client_ip", '
'"proxy_host": "$proxy_host", '
'"remote_user": "$remote_user", '
'"request": "$request", '
'"request_method": "$request_method", '
'"request_time": $request_time, '
'"request_length": $request_length, '
'"sent_http_location": "$sent_http_location", '
'"server_name": "$server_name", '
'"server_port": $server_port, '
'"status": $status, '
'"time_local": "$time_local", '
'"msec": "$msec", '
'"upstream_addr": "$upstream_addr", '
'"upstream_http_proxy_agent": "$upstream_http_proxy_agent", '
'"upstream_http_server": "$upstream_http_server", '
'"upstream_response_length": $upstream_response_length, '
'"upstream_response_time": $upstream_response_time, '
'"upstream_status": $upstream_status, '
'"x_forwarded_for": "$http_x_forwarded_for" }';


server {
    listen   8443 ssl;

    ssl_certificate      /etc/ssl/certs/mdtp.pem;
    ssl_certificate_key  /etc/ssl/private/mdtp.key;

    ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:DHE-DSS-AES128-GCM-SHA256:kEDH+AESGCM:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA:ECDHE-ECDSA-AES128-SHA:ECDHE-RSA-AES256-SHA384:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA:ECDHE-ECDSA-AES256-SHA:DHE-RSA-AES128-SHA256:DHE-RSA-AES128-SHA:DHE-DSS-AES128-SHA256:DHE-RSA-AES256-SHA256:DHE-DSS-AES256-SHA:DHE-RSA-AES256-SHA:AES128-GCM-SHA256:AES256-GCM-SHA384:AES128:AES256:AES:DES-CBC3-SHA:HIGH:!aNULL:!eNULL:!EXPORT:!DES:!RC4:!MD5:!PSK;
    ssl_prefer_server_ciphers on;
    ssl_session_timeout  10m;
    ssl_protocols        TLSv1.2 TLSv1.1 TLSv1;
    ssl_session_cache    shared:SSL_hods_proxy:1m;

    server_name _;

    access_log /var/log/nginx/access.log json_log_format;

    client_max_body_size       100m;
    client_body_buffer_size    128k;

    proxy_set_header           Host  $host;
    proxy_set_header           X-Real-IP   $remote_addr;
    proxy_set_header           X-Forwarded-For  $proxy_add_x_forwarded_for;
    proxy_set_header           X-Forwarded-Proto  $scheme;
    proxy_set_header           X-Forwarded-Server  $host;
    proxy_set_header           X-Forwarded-Host  $host;
    proxy_set_header           X-Forwarded-Port  $server_port;
    proxy_set_header           User-Agent 'Mozilla/4.0';

    proxy_connect_timeout      5;
    proxy_send_timeout         45;
    proxy_read_timeout         60;

    proxy_buffer_size          8k;
    proxy_buffers              4 32k;
    proxy_busy_buffers_size    64k;
    proxy_temp_file_write_size 64k;
    proxy_http_version 1.1;
    proxy_set_header Connection "";

    # Hide the nginx version number from the Server heading
    server_tokens off;

    # Remove 'nginx' server header
    #more_set_headers Server;

    location / {
        proxy_pass       http://application_in_task;
        proxy_next_upstream       off;
    }

    location /ping/ping {
        proxy_pass       http://application_in_task;
        proxy_next_upstream       off;
    }

    location /nginx-health {
        return 200 "healthy\n";
    }
}
